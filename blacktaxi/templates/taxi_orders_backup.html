{% extends "base.html" %}

{% block title %}–ó–∞–∫–∞–∑—ã —Ç–∞–∫—Å–∏ - –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å VIP –±–æ—Ç–∞{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">üöï –ó–∞–∫–∞–∑—ã —Ç–∞–∫—Å–∏</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <span class="text-muted">–í—Å–µ–≥–æ: {{ total }}</span>
    </div>
</div>

<!-- –§–∏–ª—å—Ç—Ä—ã -->
<div class="card mb-4">
    <div class="card-body">
        <form method="GET" class="row g-3">
            <div class="col-md-4">
                <label for="search" class="form-label">–ü–æ–∏—Å–∫</label>
                <input type="text" class="form-control" id="search" name="search" value="{{ search }}" placeholder="–ú–∞—Ä—à—Ä—É—Ç –∏–ª–∏ –∫–æ–Ω—Ç–∞–∫—Ç">
            </div>
            <div class="col-md-3">
                <label for="status" class="form-label">–°—Ç–∞—Ç—É—Å</label>
                <select class="form-select" id="status" name="status">
                    <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
                    <option value="active" {% if status_filter == 'active' %}selected{% endif %}>–ê–∫—Ç–∏–≤–Ω—ã–µ</option>
                    <option value="closed" {% if status_filter == 'closed' %}selected{% endif %}>–ó–∞–∫—Ä—ã—Ç—ã–µ</option>
                </select>
            </div>
            <div class="col-md-3 d-flex align-items-end">
                <button type="submit" class="btn btn-primary me-2">
                    <i class="fas fa-search"></i> –ù–∞–π—Ç–∏
                </button>
                <a href="{{ url_for('taxi_orders') }}" class="btn btn-outline-secondary">
                    <i class="fas fa-times"></i> –°–±—Ä–æ—Å
                </a>
            </div>
        </form>
    </div>
</div>

<!-- –¢–∞–±–ª–∏—Ü–∞ –∑–∞–∫–∞–∑–æ–≤ -->
<div class="card">
    <div class="card-body">
        {% if orders %}
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>–û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å</th>
                        <th>–¢–æ—á–∫–∞ –ê</th>
                        <th>–¢–æ—á–∫–∞ –ë</th>
                        <th>–î–∞—Ç–∞/–í—Ä–µ–º—è</th>
                        <th>–¶–µ–Ω–∞</th>
                        <th>–ü–∞—Å—Å–∞–∂–∏—Ä—ã</th>
                        <th>–¢–∏–ø –∞–≤—Ç–æ</th>
                        <th>–°—Ç–∞—Ç—É—Å</th>
                        <th>–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è</th>
                        <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                    </tr>
                </thead>
                <tbody>
                    {% for order in orders %}
                    <tr>
                        <td>{{ order.id }}</td>
                        <td>
                            {% if order.sender_username %}
                                <strong>@{{ order.sender_username }}</strong>
                                {% if order.sender_first_name %}
                                    <br><small class="text-muted">{{ order.sender_first_name }}{% if order.sender_last_name %} {{ order.sender_last_name }}{% endif %}</small>
                                {% endif %}
                            {% elif order.sender_first_name %}
                                <strong>{{ order.sender_first_name }}{% if order.sender_last_name %} {{ order.sender_last_name }}{% endif %}</strong>
                            {% else %}
                                <span class="text-muted">ID: {{ order.sender_id or 'N/A' }}</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if order.route %}
                                {% set route_parts = order.route.split(' - ') %}
                                {% if route_parts|length >= 2 %}
                                    <strong>{{ route_parts[0] }}</strong>
                                {% else %}
                                    <strong>{{ order.route }}</strong>
                                {% endif %}
                            {% else %}
                                <span class="text-muted">N/A</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if order.route %}
                                {% set route_parts = order.route.split(' - ') %}
                                {% if route_parts|length >= 2 %}
                                    <strong>{{ route_parts[1] }}</strong>
                                {% else %}
                                    <span class="text-muted">N/A</span>
                                {% endif %}
                            {% else %}
                                <span class="text-muted">N/A</span>
                            {% endif %}
                            {% if order.luggage %}
                                <br><small class="text-muted">–ë–∞–≥–∞–∂: {{ order.luggage }}</small>
                            {% endif %}
                        </td>
                        <td>
                            {% if order.date %}
                                {{ order.date }}
                                {% if order.time %}<br>{{ order.time }}{% endif %}
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td>
                            {% if order.price %}
                                <strong>{{ order.price }}‚ÇΩ</strong>
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td>
                            {% if order.passengers %}
                                {{ order.passengers }}
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td>
                            {% if order.vehicle_type %}
                                <span class="badge bg-info">{{ order.vehicle_type }}</span>
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td>
                            {% if order.status == 'active' %}
                                <span class="badge bg-success">–ê–∫—Ç–∏–≤–Ω—ã–π</span>
                            {% elif order.status == 'closed' %}
                                <span class="badge bg-secondary">–ó–∞–∫—Ä—ã—Ç</span>
                            {% else %}
                                <span class="badge bg-warning">{{ order.status }}</span>
                            {% endif %}
                        </td>
                        <td>{{ order.created_at[:10] if order.created_at else '-' }}</td>
                        <td>
                            <button type="button" class="btn btn-sm btn-outline-primary" 
                                    data-order-id="{{ order.id }}" onclick="showOrderDetails(this.dataset.orderId)">
                                <i class="fas fa-eye"></i>
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è -->
        {% if total_pages > 1 %}
        <nav aria-label="–ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ —Å—Ç—Ä–∞–Ω–∏—Ü–∞–º">
            <ul class="pagination justify-content-center">
                {% if page > 1 %}
                <li class="page-item">
                    <a class="page-link" href="{{ url_for('taxi_orders', page=page-1, search=search, status=status_filter) }}">–ü—Ä–µ–¥—ã–¥—É—â–∞—è</a>
                </li>
                {% endif %}
                
                {% for p in range(1, total_pages + 1) %}
                <li class="page-item {% if p == page %}active{% endif %}">
                    <a class="page-link" href="{{ url_for('taxi_orders', page=p, search=search, status=status_filter) }}">{{ p }}</a>
                </li>
                {% endfor %}
                
                {% if page < total_pages %}
                <li class="page-item">
                    <a class="page-link" href="{{ url_for('taxi_orders', page=page+1, search=search, status=status_filter) }}">–°–ª–µ–¥—É—é—â–∞—è</a>
                </li>
                {% endif %}
            </ul>
        </nav>
        {% endif %}
        {% else %}
        <div class="text-center py-5">
            <i class="fas fa-taxi fa-3x text-muted mb-3"></i>
            <h5 class="text-muted">–ó–∞–∫–∞–∑–æ–≤ —Ç–∞–∫—Å–∏ –ø–æ–∫–∞ –Ω–µ—Ç</h5>
            <p class="text-muted">–ó–∞–∫–∞–∑—ã –ø–æ—è–≤—è—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏, –∫–æ–≥–¥–∞ –≤ VIP –≥—Ä—É–ø–ø–µ –±—É–¥—É—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã —Å–æ–æ–±—â–µ–Ω–∏—è –æ –∑–∞–∫–∞–∑–∞—Ö —Ç–∞–∫—Å–∏.</p>
        </div>
        {% endif %}
    </div>
</div>

<!-- –ö–∞—Ä—Ç–∞ –º–∞—Ä—à—Ä—É—Ç–æ–≤ -->
<div class="card mt-4">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="mb-0">
            <i class="fas fa-map-marked-alt"></i> –ö–∞—Ä—Ç–∞ –º–∞—Ä—à—Ä—É—Ç–æ–≤
        </h5>
        <button type="button" class="btn btn-sm btn-outline-primary" onclick="refreshMap()">
            <i class="fas fa-sync-alt"></i> –û–±–Ω–æ–≤–∏—Ç—å –∫–∞—Ä—Ç—É
        </button>
    </div>
    <div class="card-body">
        <div id="map" style="width: 100%; height: 500px;"></div>
        <div class="mt-3">
            <small class="text-muted">
                <i class="fas fa-info-circle"></i> 
                –ö–∞—Ä—Ç–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ç–æ—á–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∏ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –∑–∞–∫–∞–∑–æ–≤ —Ç–∞–∫—Å–∏. 
                –ö—Ä–∞—Å–Ω—ã–µ –º–∞—Ä–∫–µ—Ä—ã - —Ç–æ—á–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏—è, —Å–∏–Ω–∏–µ - —Ç–æ—á–∫–∏ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è.
            </small>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å –¥–µ—Ç–∞–ª—è–º–∏ –∑–∞–∫–∞–∑–∞ -->
<div class="modal fade" id="orderModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">–î–µ—Ç–∞–ª–∏ –∑–∞–∫–∞–∑–∞ —Ç–∞–∫—Å–∏</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="orderModalBody">
                <!-- –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–æ –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://api-maps.yandex.ru/2.1/?apikey={{ yandex_api_key }}&lang=ru_RU" type="text/javascript"></script>
<script>
// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
let map;
let markers = [];
const ordersData = {{ orders|tojson }};

// –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
console.log('Orders data:', ordersData);
console.log('Orders count:', ordersData.length);

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã
function initMap() {
    ymaps.ready(function () {
        map = new ymaps.Map('map', {
            center: [55.7558, 37.6176], // –ú–æ—Å–∫–≤–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            zoom: 10,
            controls: ['zoomControl', 'fullscreenControl']
        });
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –º–∞—Ä—à—Ä—É—Ç—ã –Ω–∞ –∫–∞—Ä—Ç—É
        loadRoutesOnMap();
    });
}

// –ó–∞–≥—Ä—É–∑–∫–∞ –º–∞—Ä—à—Ä—É—Ç–æ–≤ –Ω–∞ –∫–∞—Ä—Ç—É
function loadRoutesOnMap() {
    console.log('Loading routes on map...');
    console.log('Orders to process:', ordersData.length);
    
    ordersData.forEach((order, index) => {
        console.log('Processing order:', order);
        console.log('Order route:', order.route);
        if (order.route) {
            const routeParts = order.route.split(' - ');
            if (routeParts.length >= 2) {
                const pointA = routeParts[0].trim();
                const pointB = routeParts[1].trim();
                
                // –ì–µ–æ–∫–æ–¥–∏—Ä—É–µ–º —Ç–æ—á–∫–∏
                geocodeAddress(pointA, 'A', order, index);
                geocodeAddress(pointB, 'B', order, index);
            }
        }
    });
}

// –ì–µ–æ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ –∞–¥—Ä–µ—Å–∞
function geocodeAddress(address, type, order, orderIndex) {
    console.log('Geocoding address:', address, 'type:', type);
    
    ymaps.geocode(address, {
        results: 1
    }).then(function (res) {
        console.log('Geocoding result for', address, ':', res);
        if (res.geoObjects.getLength() > 0) {
            const coords = res.geoObjects.get(0).geometry.getCoordinates();
            const color = type === 'A' ? '#ff0000' : '#0066ff'; // –ö—Ä–∞—Å–Ω—ã–π –¥–ª—è –ê, —Å–∏–Ω–∏–π –¥–ª—è –ë
            
            // –°–æ–∑–¥–∞–µ–º –º–∞—Ä–∫–µ—Ä
            const marker = new ymaps.Placemark(coords, {
                balloonContent: `
                    <div style="padding: 10px;">
                        <h6>${type === 'A' ? '–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏–µ' : '–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ'}</h6>
                        <p><strong>–ê–¥—Ä–µ—Å:</strong> ${address}</p>
                        <p><strong>–ó–∞–∫–∞–∑ #${order.id}</strong></p>
                        <p><strong>–¶–µ–Ω–∞:</strong> ${order.price ? order.price + '‚ÇΩ' : 'N/A'}</p>
                        <p><strong>–î–∞—Ç–∞:</strong> ${order.date || 'N/A'}</p>
                        <p><strong>–û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å:</strong> ${getSenderDisplay(order)}</p>
                    </div>
                `
            }, {
                preset: 'islands#' + (type === 'A' ? 'redDotIcon' : 'blueDotIcon'),
                iconColor: color
            });
            
            markers.push(marker);
            map.geoObjects.add(marker);
            
            // –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –∫–∞—Ä—Ç—É –Ω–∞ –ø–µ—Ä–≤–æ–º –º–∞—Ä–∫–µ—Ä–µ
            if (markers.length === 1) {
                map.setCenter(coords);
            }
        }
    }).catch(function (error) {
        console.log('–û—à–∏–±–∫–∞ –≥–µ–æ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è:', address, error);
    });
}

// –û—á–∏—Å—Ç–∫–∞ –º–∞—Ä–∫–µ—Ä–æ–≤
function clearMarkers() {
    markers.forEach(marker => {
        map.geoObjects.remove(marker);
    });
    markers = [];
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞—Ä—Ç—ã
function refreshMap() {
    clearMarkers();
    loadRoutesOnMap();
}

// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
function getSenderDisplay(order) {
    if (order.sender_username) {
        return '@' + order.sender_username;
    } else if (order.sender_first_name) {
        return order.sender_first_name + (order.sender_last_name ? ' ' + order.sender_last_name : '');
    } else {
        return 'ID: ' + (order.sender_id || 'N/A');
    }
}

function getRoutePointB(route) {
    if (!route) return 'N/A';
    const parts = route.split(' - ');
    return parts.length > 1 ? parts[1] : 'N/A';
}

function getRoutePointA(route) {
    if (!route) return 'N/A';
    const parts = route.split(' - ');
    return parts.length > 1 ? parts[0] : route;
}

function showOrderDetails(orderId) {
    const modal = new bootstrap.Modal(document.getElementById('orderModal'));
    modal.show();
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–µ—Ç–∞–ª–∏ –∑–∞–∫–∞–∑–∞
    fetch(`/api/taxi_order/${orderId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const order = data.order;
                const routePointA = getRoutePointA(order.route);
                const routePointB = getRoutePointB(order.route);
                const senderDisplay = getSenderDisplay(order);
                const priceDisplay = order.price ? order.price + '‚ÇΩ' : 'N/A';
                
                document.getElementById('orderModalBody').innerHTML = `
                    <div class="row">
                        <div class="col-md-6">
                            <h6>–û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h6>
                            <p><strong>–û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å:</strong> ${senderDisplay}</p>
                            <p><strong>–¢–æ—á–∫–∞ –ê:</strong> ${routePointA}</p>
                            <p><strong>–¢–æ—á–∫–∞ –ë:</strong> ${routePointB}</p>
                            <p><strong>–î–∞—Ç–∞:</strong> ${order.date || 'N/A'}</p>
                            <p><strong>–í—Ä–µ–º—è:</strong> ${order.time || 'N/A'}</p>
                            <p><strong>–¶–µ–Ω–∞:</strong> ${priceDisplay}</p>
                            <p><strong>–ü–∞—Å—Å–∞–∂–∏—Ä—ã:</strong> ${order.passengers || 'N/A'}</p>
                        </div>
                        <div class="col-md-6">
                            <h6>–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ</h6>
                            <p><strong>–¢–∏–ø –∞–≤—Ç–æ:</strong> ${order.vehicle_type || 'N/A'}</p>
                            <p><strong>–ë–∞–≥–∞–∂:</strong> ${order.luggage || 'N/A'}</p>
                            <p><strong>–î–æ–ø. —É—Å–ª—É–≥–∏:</strong> ${order.additional_services || 'N/A'}</p>
                            <p><strong>–ö–æ–Ω—Ç–∞–∫—Ç:</strong> ${order.contact || 'N/A'}</p>
                            <p><strong>–°—Ç–∞—Ç—É—Å:</strong> ${order.status || 'N/A'}</p>
                        </div>
                    </div>
                    <hr>
                    <h6>–ò—Å—Ö–æ–¥–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ</h6>
                    <div class="bg-light p-3 rounded">
                        <pre>${order.source_message || 'N/A'}</pre>
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            document.getElementById('orderModalBody').innerHTML = '<p class="text-danger">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö</p>';
        });
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', function() {
    initMap();
});
</script>
{% endblock %} 
{% extends "base.html" %}

{% block title %}–ü–ª–∞—Ç–µ–∂–∏ - –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å VIP –±–æ—Ç–∞{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">üí≥ –ü–ª–∞—Ç–µ–∂–∏</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <span class="text-muted">–í—Å–µ–≥–æ: {{ total }}</span>
    </div>
</div>

<!-- –§–∏–ª—å—Ç—Ä—ã -->
<div class="card mb-4">
    <div class="card-body">
        <form method="GET" class="row g-3">
            <div class="col-md-3">
                <label for="status" class="form-label">–°—Ç–∞—Ç—É—Å</label>
                <select class="form-select" id="status" name="status">
                    <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
                    <option value="CONFIRMED" {% if status_filter == 'CONFIRMED' %}selected{% endif %}>–£—Å–ø–µ—à–Ω–æ</option>
                    <option value="PENDING" {% if status_filter == 'PENDING' %}selected{% endif %}>–û–∂–∏–¥–∞–µ—Ç</option>
                    <option value="FAILED" {% if status_filter == 'FAILED' %}selected{% endif %}>–û—à–∏–±–∫–∞</option>
                    <option value="CANCELLED" {% if status_filter == 'CANCELLED' %}selected{% endif %}>–û—Ç–º–µ–Ω–µ–Ω</option>
                </select>
            </div>
            <div class="col-md-3 d-flex align-items-end">
                <button type="submit" class="btn btn-primary me-2">
                    <i class="fas fa-filter"></i> –§–∏–ª—å—Ç—Ä
                </button>
                <a href="{{ url_for('payments') }}" class="btn btn-outline-secondary">
                    <i class="fas fa-times"></i> –°–±—Ä–æ—Å
                </a>
            </div>
        </form>
    </div>
</div>

<!-- –¢–∞–±–ª–∏—Ü–∞ –ø–ª–∞—Ç–µ–∂–µ–π -->
<div class="card">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>ID –ø–ª–∞—Ç–µ–∂–∞</th>
                        <th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
                        <th>–°—É–º–º–∞</th>
                        <th>–°—Ç–∞—Ç—É—Å</th>
                        <th>–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è</th>
                        <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                    </tr>
                </thead>
                <tbody>
                    {% for payment in payments %}
                    <tr>
                        <td>
                            <code>{{ payment.payment_id }}</code>
                        </td>
                        <td>
                            {% if payment.username %}
                                {{ payment.username }}
                            {% else %}
                                <span class="text-muted">{{ payment.user_id }}</span>
                            {% endif %}
                        </td>
                        <td>
                            <strong>{{ payment.amount }}‚ÇΩ</strong>
                        </td>
                        <td>
                            {% if payment.status == 'CONFIRMED' %}
                                <span class="badge bg-success">–£—Å–ø–µ—à–Ω–æ</span>
                            {% elif payment.status == 'PENDING' %}
                                <span class="badge bg-warning">–û–∂–∏–¥–∞–µ—Ç</span>
                            {% elif payment.status == 'FAILED' %}
                                <span class="badge bg-danger">–û—à–∏–±–∫–∞</span>
                            {% elif payment.status == 'CANCELLED' %}
                                <span class="badge bg-secondary">–û—Ç–º–µ–Ω–µ–Ω</span>
                            {% else %}
                                <span class="badge bg-info">{{ payment.status }}</span>
                            {% endif %}
                        </td>
                        <td>{{ payment.created_at[:19] }}</td>
                        <td>
                            {% if payment.status == 'CONFIRMED' %}
                                <div class="btn-group" role="group">
                                    <button type="button" class="btn btn-sm btn-danger" 
                                            onclick="cancelPayment('{{ payment.payment_id }}', null, '{{ payment.amount }}')">
                                        <i class="fas fa-times"></i> –û—Ç–º–µ–Ω–∏—Ç—å
                                    </button>
                                    <button type="button" class="btn btn-sm btn-warning" 
                                            onclick="showPartialCancelModal('{{ payment.payment_id }}', '{{ payment.amount }}')">
                                        <i class="fas fa-minus"></i> –ß–∞—Å—Ç–∏—á–Ω–æ
                                    </button>
                                </div>
                            {% elif payment.status == 'PENDING' %}
                                <button type="button" class="btn btn-sm btn-danger" 
                                        onclick="cancelPayment('{{ payment.payment_id }}', null, '{{ payment.amount }}')">
                                    <i class="fas fa-times"></i> –û—Ç–º–µ–Ω–∏—Ç—å
                                </button>
                            {% else %}
                                <span class="text-muted">-</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è -->
        {% if total_pages > 1 %}
        <nav aria-label="–ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ —Å—Ç—Ä–∞–Ω–∏—Ü–∞–º">
            <ul class="pagination justify-content-center">
                {% if page > 1 %}
                <li class="page-item">
                    <a class="page-link" href="{{ url_for('payments', page=page-1, status=status_filter) }}">–ü—Ä–µ–¥—ã–¥—É—â–∞—è</a>
                </li>
                {% endif %}
                
                {% for p in range(1, total_pages + 1) %}
                <li class="page-item {% if p == page %}active{% endif %}">
                    <a class="page-link" href="{{ url_for('payments', page=p, status=status_filter) }}">{{ p }}</a>
                </li>
                {% endfor %}
                
                {% if page < total_pages %}
                <li class="page-item">
                    <a class="page-link" href="{{ url_for('payments', page=page+1, status=status_filter) }}">–°–ª–µ–¥—É—é—â–∞—è</a>
                </li>
                {% endif %}
            </ul>
        </nav>
        {% endif %}
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —á–∞—Å—Ç–∏—á–Ω–æ–π –æ—Ç–º–µ–Ω—ã -->
<div class="modal fade" id="partialCancelModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">–ß–∞—Å—Ç–∏—á–Ω–∞—è –æ—Ç–º–µ–Ω–∞ –ø–ª–∞—Ç–µ–∂–∞</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="partialCancelForm">
                    <div class="mb-3">
                        <label for="cancelAmount" class="form-label">–°—É–º–º–∞ –¥–ª—è –æ—Ç–º–µ–Ω—ã (–≤ –∫–æ–ø–µ–π–∫–∞—Ö)</label>
                        <input type="number" class="form-control" id="cancelAmount" required min="1">
                        <div class="form-text">–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É –≤ –∫–æ–ø–µ–π–∫–∞—Ö (–Ω–∞–ø—Ä–∏–º–µ—Ä, 5000 = 50‚ÇΩ)</div>
                    </div>
                    <div class="mb-3">
                        <label for="cancelReason" class="form-label">–ü—Ä–∏—á–∏–Ω–∞ –æ—Ç–º–µ–Ω—ã</label>
                        <textarea class="form-control" id="cancelReason" rows="3" placeholder="–£–∫–∞–∂–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É –æ—Ç–º–µ–Ω—ã..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                <button type="button" class="btn btn-warning" onclick="confirmPartialCancel()">–û—Ç–º–µ–Ω–∏—Ç—å —á–∞—Å—Ç–∏—á–Ω–æ</button>
            </div>
        </div>
    </div>
</div>

<script>
let currentPaymentId = null;
let currentTotalAmount = null;

function showPartialCancelModal(paymentId, totalAmount) {
    currentPaymentId = paymentId;
    currentTotalAmount = parseInt(totalAmount) * 100; // –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ –∫–æ–ø–µ–π–∫–∏
    document.getElementById('cancelAmount').max = currentTotalAmount;
    document.getElementById('cancelAmount').placeholder = `–ú–∞–∫—Å–∏–º—É–º: ${currentTotalAmount} –∫–æ–ø–µ–µ–∫`;
    new bootstrap.Modal(document.getElementById('partialCancelModal')).show();
}

function confirmPartialCancel() {
    const amount = parseInt(document.getElementById('cancelAmount').value);
    if (!amount || amount <= 0 || amount > currentTotalAmount) {
        alert('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—É–º–º—É –¥–ª—è –æ—Ç–º–µ–Ω—ã');
        return;
    }
    
    cancelPayment(currentPaymentId, amount, currentTotalAmount / 100);
    bootstrap.Modal.getInstance(document.getElementById('partialCancelModal')).hide();
}

function cancelPayment(paymentId, amount = null, totalAmount = null) {
    const confirmMessage = amount ? 
        `–û—Ç–º–µ–Ω–∏—Ç—å ${amount} –∫–æ–ø–µ–µ–∫ –∏–∑ –ø–ª–∞—Ç–µ–∂–∞ ${paymentId}?` :
        `–ü–æ–ª–Ω–æ—Å—Ç—å—é –æ—Ç–º–µ–Ω–∏—Ç—å –ø–ª–∞—Ç–µ–∂ ${paymentId}?`;
    
    if (!confirm(confirmMessage)) {
        return;
    }
    
    const data = {
        payment_id: paymentId
    };
    
    if (amount !== null) {
        data.amount = amount;
    }
    
    fetch('/api/cancel_payment', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('–ü–ª–∞—Ç–µ–∂ —É—Å–ø–µ—à–Ω–æ –æ—Ç–º–µ–Ω–µ–Ω!');
            location.reload();
        } else {
            alert('–û—à–∏–±–∫–∞ –æ—Ç–º–µ–Ω—ã –ø–ª–∞—Ç–µ–∂–∞: ' + (data.message || data.error));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–º–µ–Ω–µ –ø–ª–∞—Ç–µ–∂–∞');
    });
}
</script>
{% endblock %} 